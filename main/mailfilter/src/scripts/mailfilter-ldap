#!/usr/bin/perl
use strict;
use warnings;

use EBox;
use EBox::Global;
use EBox::MailVDomainsLdap;
use EBox::MailFilter::VDomainsLdap;
use EBox::Sudo qw(root);
use EBox::Users::User;

sub update
{
    my $users =  EBox::Global->modInstance('users');

    my $container = EBox::Users::User->defaultContainer();
    my @controlUsers = (
        {
            uid => 'spam',
            givenname => 'Spam',
            surname  => 'spam',
            parent => $container,
            isSystemUser => 1,
            isInternal => 1,
        },
        {
            uid => 'ham',
            givenname => 'Ham',
            surname => 'ham',
            parent => $container,
            isSystemUser => 1,
            isInternal => 1,
        },
    );

    foreach my $user_r (@controlUsers) {
        my $username = $user_r->{uid};
        my $user = new EBox::Users::User(uid => $username);
        unless ($user->exists()) {
            EBox::debug("Creating user '$username'");
            EBox::Users::User->create(%$user_r);
        } else {
            unless ($user->isSystem()) {
                die $user->name() . " is not a system user as it has to be";
            }
        }
    }

    my $vdomainMailfilter = new EBox::MailFilter::VDomainsLdap;
    my @vdomains = _vdomains();
    foreach my $vdomain (@vdomains) {
        $vdomainMailfilter->_addVDomain($vdomain);
    }
}


sub clean
{
    my $vdomainMailfilter = new EBox::MailFilter::VDomainsLdap;
    my @vdomains = _vdomains();
    foreach my $vdomain (@vdomains) {
        $vdomainMailfilter->_delVDomain($vdomain);
    }
}

sub _vdomains
{
    my $vdomainMail       = new EBox::MailVDomainsLdap;
    return $vdomainMail->vdomains();
}

sub usage
{
    print "Usage: $0 update | clean\n";
    exit 1;
}

EBox::init();

unless ($#ARGV == 0) {
    usage();
}

if ($ARGV[0] eq 'update') {
    update();
} elsif ($ARGV[0] eq 'clean') {
    clean();
} else {
    usage();
}

1;
